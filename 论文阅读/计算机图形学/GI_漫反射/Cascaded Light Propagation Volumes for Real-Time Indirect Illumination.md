# Cascaded Light Propagation Volumes for Real-Time Indirect Illumination

![image-20220221132544188](Cascaded Light Propagation Volumes for Real-Time Indirect Illumination.assets/image-20220221132544188.png)



## 1. 介绍

在本文中，我们提出了一种新的方法，用于为**完全动态的场景**渲染**可信的间接照明**，而这种方法不需要进行预计算。本文方法是对**SIGGRAPH'09课程计划**中提出的基本技术的进一步发展，即使计算时间有限，也能产生可信的、视觉上令人愉悦的结果——没有闪烁，而且具有强时间一致性。

通过使用一个存储**场景中的光线和几何图形**的==网格==来实现这一点。光的方向分布用**低阶球面谐波**表示。我们使用`reflective shadow maps`（==RSM==）对表面进行采样，并使用这些信息在**每一帧中从头初始化网格**。基于这种表示方法，我们开发了一种**数据平行的光线传播方案**，能够快速地、合理地近似**低频直接和间接照明**。我们的**传播方案**（`propagation scheme`）来自==离散坐标法==（`Discrete Ordinates Method`）。来自点光源或小面积光源的直接照明是使用标准技术计算的。本文方法已被整合到**CryENGINE 3**，并通过不同分辨率的嵌套网格来处理**大型全动态场景**。



## 2. Light Propagation Volumes

我们的工作受到了`discrete ordinate methods`和**`Lattice- Boltzmann`照明技术**的启发。与这些方法类似，我们在一个网格上采样的场景中表示照明。这使我们能够使用**简单的、局部的操作**来模拟**光的传输**，而这些操作又可以很容易**并行化**。本文的计算基于存储在网格的每个**单元**（`cell`）的强度。我们的贡献包括：

+ 快速初始化用于光传播的网格，可以为每一帧从头开始计算一个新的传播方案。（着主轴方向传播，与其他方案中的`26`个方向相反）
+ 仍然为**低频照明**提供**良好的结果**。
+ 一个处理大场景的**分层方法**。

在下文中，将描述此方法的**基本步骤**。为此，假设场景被嵌入到一个**固定分辨率的三维网格**中（后文通过引入**级联网格**消除这一限制）。我们有**两个网格**，一个存储了==强度==（造成低频间接照明）；另一个网格存储了==场景几何形状的体积近似值==——当光线穿过场景时用于**模糊遮挡**（`fuzzy blocking`）。这两个网格都存储了一个**球谐函数**，表示为**低频的SH近似值**。

用此技术计算**间接照明**包括**四个后续步骤**：

- 用引起**间接照明和低频直射光**（区域光源）的表面初始化==光传播体==（`LPV`）。
- 利用摄像机的**深度剥离**（`depth peeling`）和多个`RSM`对场景的表面进行采样。这些信息被用来创建一个粗略的**遮挡几何体的体积表示**。
- 从**最初的LPV**开始进行**光的传播**，并积累中间结果（产生最终的**光分布**）。
- 使用**传播的光**照亮**场景中的几何体**。除了直接将`LPV`用于**漫反射照明**外，还提出了对**光泽间接照明**和**参与介质**的合理近似。



### 2.1 LPV Initialization

使用**光传播体（`LPV`）**来计算场景中的低频照明。第一步是将**造成这种光照的表面**转化为**方向性强度表示**，并相应地**初始化LPV**。

初始化是基于这样的想法：即可以按照[Keller 1997]的精神，将**低频照明**转换成**一组虚拟点光源**（`VPLs`）。然而，我们使用的**VPLs数量**明显多于**即时辐射度方法**，因为不单独计算它们的贡献，而只是用它们来**初始化LPV**。

***Indirect* light**

我们首先通过为每个光源渲染`RSM`，来创建间接照明的`VPLs`。`RSM`的每个`texel`可以解释为一个**小面积的光源**——它的方向强度分布（`radiant intensity`）$I_p(w)$，由方向$n_p$和反射通量$\Phi_p$决定：

<img src="Cascaded Light Propagation Volumes for Real-Time Indirect Illumination.assets/image-20220221144558612.png" alt="image-20220221144558612" style="zoom: 80%;" />

> $<|>_+$是`clamp dot`。

为了简单起见，在这里省略了**光谱的依赖性**。下一步是将**所有的VPLs**转化为**SH表示**，并将**它们的贡献**存储在`LPV Cell`中。我们可以很容易地确定**VPL所在的单元**。如果**VPL的指向**远离该单元的中心，我们就不想把它的贡献加到这个单元，而是加到**下一个单元**，以避免`self lighting`和阴影。为此，在确定单元之前，将每个`VPL`在其**法线方向**上移动**一半的单元间距**。在该单元中，只考虑**VPL的方向**，忽略它在该单元中的确切位置。

我们用`SH`来表示**强度的方向分布**。

> ![image-20220221150824921](Cascaded Light Propagation Volumes for Real-Time Indirect Illumination.assets/image-20220221150824921.png)

请2注意，**VPL的通量**已经包含了**创建VPL的像素的面积**。因此不需要进一步的缩放，就可以在网格单元中**积累强度**，即**SH近似的系数**。事实上，我们用**`3`个系数向量**来表示**RGB数据**；然而，为了解释方法，我们只显示了**一个组成部分**。

每个`VPL`都以这种方式处理，然后 "**注入 "LPV**中。在确定网格单元后，简单地**累积SH系数**。请注意，这个过程引入了**照明的空间离散性**，并且内在地假定:**导致间接照明的表面**在一个单元内**不会相互遮挡**。



***Low-frequency direct light***

==第二种VPL==是指来自区域灯光、环境贴图和较大的点光源组的**低频直接照明**。同样，我们为这些光源创建一个**密集的采样**——几百到几千个`VPLs`，并以与`RSMs`完全相同的方式将它们**注入`LPV`中**。**来自环境图的VPLs**被注入到**LPV单元的外**层；网格外的其他VPLs被省略。



### 2.2 Scene Geometry Injection

除了**初始强度分布**之外，我们还创建了一个**场景表面的体积表示法**。这种几何形状的粗略近似被用来在传播过程中阻挡光线，从而计算间接阴影。

我们的目标是完全动态的场景，不需要预先计算，因此，这些信息也必须在飞行中创建。为此，我们重新使用存储在摄像机视图的深度和法线缓冲区（使用延迟渲染器）以及RSM中的场景表面采样。请注意，我们通常为许多光源创建RSM，因此对场景的大部分表面进行了密集的采样。如果需要，我们可以通过为RSMs或摄像机视图添加深度剥离通道来收集更多信息。也可以使用预先计算的表面点采样，类似于[Ritschel等人，2008]，但这意味着额外的存储和转换成本。



