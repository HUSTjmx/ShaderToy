# Chapter 9——Physically Based Shading

## 1.  Physics of Light

==光和物质的相互作用形成了PBS的基础==。为了理解这些相互作用，对光的本质有一个基本的理解是有帮助的。在==物理光学==中，光被建模为电磁横波`transverse wave`——一种使电场和磁场垂直于其传播方向的波。这两个场的振荡是耦合的（ coupled）。磁场和电场矢量相互垂直，它们的长度之比是固定的（这个比值等于相速度` phase velocity`，==通常称其为光速c==）

下图是一个最简单的光波——一个完美的Sin曲线。这种波只有一个波长，用$\lambda$表示。单波长的光叫做单色光`monochromatic light`。然而，实际中遇到的大多数光波是多色的，包含许多不同的波长。在另一方面，单色光也是非常简单——它是`linearly polarized`的（偏振的）。这意味着，在空间的一个固定点上，电场和磁场都沿着一条线来回移动。相反，在这本书中，我们关注的是==更普遍的非偏振光==——在非偏振光中，场振荡` the field oscillations`均匀地分布在所有方向（垂直于传播轴的）上。尽管它们很简单，但==理解单色线性偏振波的行为是有用的，因为任何光波都可以分解成这些波的组合==。

<img src="RTR4_C9.assets/image-20201026132200500.png" alt="image-20201026132200500" style="zoom:80%;" />

波长`wavelength`通常多大呢？可以拿蜘蛛丝和头发来对比：

<img src="RTR4_C9.assets/image-20201026133655439.png" alt="image-20201026133655439" style="zoom:67%;" />

光波携带能量，能量流的密度等于电场和磁场的乘积，由于磁场和电场成比例，所以也就是与电场的平方成比例。==我们关注电场==，因为它对物质的影响比磁场强得多。==在渲染中，我们关注的是随时间的变化的平均能量流，这与波振幅的平方成比例==。==这个平均能量流的密度就是辐照度E==。==光波线性结合==——总波是各分量波的和。然而，由于辐照度与振幅的平方成比例，这似乎会导致一个==悖论==。两个相等的波相加，不会导致“1 + 1 = 4”的情况吗？既然辐照度E度量的是能量流，这不会破坏能量守恒吗？这两个问题的答案是：分别是==“有时”和“不”==。

为了说明，举一个简单的例子：n个单色波的加法，除了相位相同之外。每n波的振幅为a。如前所述，每一波的辐照度E~1~与$a^2$成正比，换句话说：$E_1 = ka^2$。见下图，n个单色波相加的三种情况，左边的情况是`constructive interference`，中间是`destructive interference`。这两个都是`coherent addition`（相干叠加）的特殊情况，所以第一个问题的答案是"有时"。

![image-20201026135308585](RTR4_C9.assets/image-20201026135308585.png)

但大多数情况（上图右），波的叠加是不相干的`incoherent`，在这种情况下，组合波的振幅是√n，每个波的辐照度加起来，线性地等于初始辐照度的n倍。但只按照上图左、中，似乎不满足能量守恒，但是上诉知识空间某个位置的情况，随着位置移动，相位会发生变化，如下图：（这并不违反能量守恒定律，因为通过相长干涉获得的能量和通过相长干涉损失的能量总是可以抵消掉）

![image-20201026140547601](RTR4_C9.assets/image-20201026140547601.png)

光离开光源后，在空间中遨游，直到遇到和其交互的物质。==光-物交互的核心理论是简单的==：振荡的电场对物质中的电荷进行推拉，使它们依次振荡；振荡的电荷发射出新的光波，使入射光波的部分能量定向到新的方向。==这也就是各种渲染理论的基础——散射==`scattering`。

散射的光波与原波的频率相同。通常情况下，当原波包含多个频率的光波时，每个频率的光波都会分别与物质发生作用（也只会对相同频率的出射光产生影响），除了荧光和磷光，我们在本书中不会介绍。

在渲染中，我们关注的是分子的集合。集合体的相互作用与孤立分子的相互作用不一样。从附近的分子散射出来的波通常是相干的，因此表现出干扰，因为它们来源于同一个入射波。The rest of this section is devoted to several important special cases of light scattering from multiple molecules。



### 1.1 Particles

==在理想的气体中，分子通常不会相互影响==，它们的相关位置是完全随机和无关的。在这种情况下，不同分子散射的波之间的相位差是随机的，并且不断变化。因此，它们的能量线性增加，如图9.3的右部。相反，如果分子紧密地挤在比光的波长小得多的团簇中，散射光的波长是同相位的，此时，能量平方增加，如图9.3的左部。

这个解释了为什么云和雾如此强烈地散射光线。它们都是由凝结产生的——空气中的水分子聚集成越来越大的团簇，这大大增加了光的散射。

当讨论光散射时，粒子`particles`用于指孤立的分子和多分子团簇。由于来自多分子聚簇（直径小于波长）的散射是来自孤立分子的散射的放大，它表现出相同的方向变化和波长依赖性。这种类型的散射在大气粒子中称为`Rayleigh scattering`，在固体颗粒中称为`Tyndall scattering`。当粒子越来越大，散射光的波长依赖性越来越低，这种类型的散射称为`Mie scattering`。



### 1.2 Media

另一个重要的情况是==光通过均匀介质传播==，均匀介质包括：晶体，不含杂质、无缝隙的液体和其它固体。在均质介质中，散射波在除原传播方向外的所有方向上都发生破坏性干扰`interfere destructively`。原始波与各个分子散射的波结合后。除了相位速度和（在某些情况下）振幅之外，==最终结果与原始波相同，不表现出任何散射效应==。

旧波和新波的相速度之比，构成了介质的一个光学属性，`index of refraction`（==IOR==、折射率，用n表示）。有些介质具有吸收性，其中的光，随着距离的不断深入，强度逐渐衰减——下降的速率被称为`attenuation index`（用$\kappa$表示）。这两者通常组合起来，$n+i\kappa$，称之为==复折射率==`complex index of refraction`。折射率将分子层面上，光与介质相互作用的细节抽象出来，and enables treating the medium as a continuous volume, which is much simpler。

![image-20201027133006222](RTR4_C9.assets/image-20201027133006222.png)

==非均匀介质通常可以被模拟为：在均匀介质中嵌入散射粒子==。 Such a localized change can be a cluster of a different molecule type, an air gap, a bubble, or density variation。在任何情况下，就像前面讨论的粒子一样散射光，其特性同样依赖于聚簇团的大小，甚至气体也可以用这种方法建模。下图是几个散射`scattering`的例子：

![image-20201027133706422](RTR4_C9.assets/image-20201027133706422.png)

散射和吸收`absorption`都是大小相关的。小场景中，某些介质（水、空气）的视觉效果不明显，但在大场景中就是特别重要（如下图所示）

<img src="RTR4_C9.assets/image-20201027155905417.png" alt="image-20201027155905417" style="zoom:67%;" />

介质的亮度是这两种现象的综合结果。特别是白色——高散射和低吸收结合的结果

<img src="RTR4_C9.assets/image-20201027162946726.png" alt="image-20201027162946726" style="zoom:67%;" />



###  1.3 Surface

相比介质内部的缝隙和密度不均匀，物体表面（不同介质的交界处）是一种特殊的、导致散射的“不连续”情况。边界条件要求平行于表面的电场是连续的，换句话说：the projection of the electric field vector to the surface plane must match on either side of the surface。==这有几个含义==：

- 在表面上，散射波的波峰必须与入射波的波峰或波谷对齐。这就限制了散射波只能向两个可能的方向传播，一个继续进入表面（折射光），另一个离开表面（反射光）。
- 散射波必须与入射波具有相同的频率。
- 相速度`phase velocity`和相对折射率(n1 / n2)成比例变化。由于频率是固定的，所以波长也按比例变化为(n1/n2)。

折射光的角度和入射光的角度之间的关系：(==Snell’s law==)
$$
sin(\theta_t)=\frac{n_1}{n_2}sin(\theta_i)
$$
<img src="RTR4_C9.assets/image-20201027162120204.png" alt="image-20201027162120204" style="zoom:67%;" />

==不透明物体也存在光的折射==。比如：对于金属而言，内部包含很多自由电子，它们会吸收折射光，并将光重定向到反射光上，所以，金属同时具有和高吸收性和高反射性。

目前我们讨论的折射内容，都是在IOR上进行突变（发生在小于一个波长的距离上的）。而==一个渐变的IOR== ，不会切割光的传播路径，但是会扭曲它的传播。这个效果通常见于空气密度会因温度而变化的情况，例如：海市蜃楼和热变形（如下图）

![image-20201027163724096](RTR4_C9.assets/image-20201027163724096.png)

如果一个物体的表面没有IOR的变化，那么折射和反射都不发生，它就是不具有` visible surface`（下图书中的小球具备一定的可见性，是由于它对光的吸收性）

<img src="RTR4_C9.assets/image-20201027164408589.png" alt="image-20201027164408589" style="zoom:67%;" />

​	除了表面的IOR区别，==另外一个影响表面的因素==是` geometry`。比波长小得多的表面不规则性` irregularities`对光没有影响，而比波长大得多的不规则性倾斜表面，而不影响其局部平整度；只有波长在1-100范围内的不规则现象，才会通过一种叫做衍射`diffraction`的现象使表面表现出与平面不同的行为。我们将在后面进一步讨论这种现象（C 9.11）

在渲染中，我们通常使用==几何光学==（以上都是物理光学），忽略了波的影响，如干涉和衍射。在几何光学中，光被建模成光线`Ray`，而不是波`wave`。回到本章和上一段提到的情况，也就是所谓的微观几何`microgeometry`。在渲染中，我们是直接处理的，例如BRDF中的几何项G——表面具有随机分布的微观法线，因此，我们沿连续方向扩散反射（和折射）光。扩展的宽度，以及反射和折射细节的模糊程度，==取决于微观几何法向矢量的统计方差==——换句话说，表面的微尺度粗糙度`roughness`。

<img src="RTR4_C9.assets/image-20201027170125123.png" alt="image-20201027170125123" style="zoom: 80%;" />



###  1.4 Subsurface Scattering

正如之前所言，金属反射大部分光，并快速吸收剩下的光；而非金属物体则在这两方面表现各不相同。在这一章中，将集中讨论不透明的物体，在这些物体中，透射光经过多次散射和吸收，直到最后一部分光从表面重新发射回来。

<img src="RTR4_C9.assets/image-20201027170521755.png" alt="image-20201027170521755" style="zoom:67%;" />

距离（出点和入点间的）和阴影尺度（像素的大小，或采样之间的距离）之间的关系很重要。==如果这个entry-exit距离小于后者==，表面下的散射与表面反射结合成一个局部着色模型，在一个点上发出的光只依赖于同一点上的入射光。 The `specular term` models surface reflection, and the `diffuse term` models local subsurface scattering；否则，就需要考虑，其它点散射对某点的影响了。

