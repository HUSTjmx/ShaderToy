# Chapter 18——Pipeline Optimization

<span style="color:red;font-size:1.3rem">过早的优化是万恶之源</span>

瓶颈检测和优化是重点。从进行**小的、局部的更改**开始，到将应用程序作为一个整体来构建，以利用多处理能力的技术结束。

管道优化是一个过程，我们首先最大化渲染速度，然后允许**没有瓶颈的阶段**，消耗像瓶颈一样多的时间。也就是说，这并不总是一个简单的过程，因为gpu和驱动程序可以有自己的特性和快速路径。读这一章的时候，记住：

<span style="color:red;font-size:1.3rem">KNOW YOUR ARCHITECTURE</span>



## 1. Profiling and Debugging Tools

==分析和调试工具==在发现代码中的性能问题时非常有价值。功能各不相同，可以包括：

- **帧捕捉和可视化**。通常可以使用分步帧重播，显示所使用的状态和资源。
- 分析花费在**CPU**和**GPU**上的时间，包括调用图形**API**的时间。
- **着色器调试**，并可以热编辑，以看到改变的代码的效果。
- 使用在应用程序中设置的**调试标记**，以帮助识别代码区域

==分析和调试工具==因操作系统、图形API和GPU供应商而异。大多数组合都有相应的工具，这就是==**上帝创造谷歌**==的原因。也就是说，我们会提到一些专门用于交互式图形的**包名**，让你开始你的任务：

- ==RenderDoc==是一个高质量的Windows调试器，用于DirectX, OpenGL和Vulkan，最初由Crytek开发，现在开源。:star:
- ==GPU PerfStudio==是AMD为其图形硬件提供的工具套件，适用于Windows和Linux。值得注意的工具是一个==静态着色分析器==，它可以在不运行应用程序的情况下进行性能评估。AMD的Radeon GPU Profiler是一个单独的相关工具。
- ==NVIDIA Nsight==是一个具有广泛功能的性能和调试系统。它集成了Windows上的Visual Studio和Mac OS和Linux上的Eclipse。
- 微软的**GPUView**使用了Windows事件跟踪(ETW)，这是一种高效的事件记录系统。GPUView是ETW会话的消费者程序之一。重点讨论了CPU和GPU之间的交互问题，指出了其中的瓶颈所在。
- ==图形性能分析器==(**GPA**)是英特尔的一个套件，不是专门针对他们的图形芯片，它专注于性能和帧分析。



## 2. Locating the Bottleneck

优化管道的第一步是找到**最大的瓶颈** [**1679**]。找到瓶颈的一种方法是：设置几个测试，每个测试减少特定阶段执行的工作量。如果其中一个测试导致每秒帧数增加，则发现瓶颈阶段。

###  2.1 Testing the Application Stage

如果为使用的平台提供了一个**实用程序**，来测量处理器上的工作负载，那么可以使用该实用程序来查看您的程序是否使用了100%(或接近100%)的CPU处理能力。

测试==CPU限制==的一个更聪明的方法是：发送导致GPU很少工作或不工作的数据。对于一些系统，这可以通过简单地使用一个空驱动来完成。通过做这个测试，可以了解到对于**不在应用程序阶段运行的**、基于gpu的阶段有多大的改进空间。**驱动程序**通常是CPU端瓶颈的原因，我们将在后面深入讨论这个话题。

### 2.2 Testing the Geometry Processing Stage

==几何阶段是最难测试的阶段==。这是因为如果这个阶段的**工作负载**发生了变化，那么其他阶段中的一个或两个工作负载也经常发生变化。为了避免这一问题，Cebenoyan [**240**]给出了一系列从==光栅化阶段==反向运行的测试。

在几何阶段有**两**个主要的领域会出现瓶颈：==顶点获取和处理==。要查看瓶颈是否由对象数据传输引起，可以增加顶点格式的大小。这可以通过每个顶点发送几个额外的纹理坐标来实现。如果性能下降，这个区域就是瓶颈。