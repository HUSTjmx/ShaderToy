[toc]





# An Approximation to the Chapman Grazing-Incidence Function for Atmospheric Scattering

![image-20210819113120941](C5.assets/image-20210819113120941.png)



## 1. 介绍

**计算机图形的大气散射**是将大气作为一种**参与媒介**来处理，基本上是 "计算天空的颜色"。一个共同主题是找到有效评估或预计算==Chapman函数==的方法，$Ch(x, χ)$。这是球形对称、指数下降的大气中的**射线的密度积分**。查普曼函数在物理学文献中已经得到了广泛的处理。本文为其计算探索了一个不同的方向：一个便宜到**$Ch(x, χ)$可以被认为是商品`commodity`**的近似值，同时仍然足够准确。



## 2. 大气散射

本节是对大气散射的简要回顾和术语的定义。当光穿过空气时，它将部分被吸收，部分被散射到其他方向。这就产生了**空中透视的现象**。沿着一条路径**不受阻碍的那部分光**是透射率`T`，而由于散射而被加入路径的量是**内散射**`S`：

![image-20210819113939968](C5.assets/image-20210819113939968.png)

为了得到总的内散射`S`，一般来说，我们必须沿着路径进行积分。然后，在一个特定的点 $S(t)$的散射（$f(\theta)$是相位函数）：

![image-20210819114033556](C5.assets/image-20210819114033556.png)

辐照度通常被**离散化为单个贡献的总和**。特别是在白天，最重要的贡献者是太阳，它可以简化为一个定向的点源$E_{sun}$，用于**到达大气边界的辐照度**；$E_{sun}$在从大气边界到$S(t)$的路径上被**透射率**$T_{sun}$所衰减：

![image-20210819114720172](C5.assets/image-20210819114720172.png)

**透射率本身**是空气质量`m`乘以**消光系数**$β$的**指数递减函数**，后者是**散射介质的属性**，可能与波长有关。**空气质量**是沿路径的空气密度$ρ(t)$的积分：

![image-20210819114956325](C5.assets/image-20210819114956325.png)



## 3. The Chapman Function

为了**降低算法的复杂性**，最好能有一种有效的方法来计算**沿射线的透射率**。事实证明，这可以简化为对**查普曼函数**的计算。在不丧失一般性的情况下，让我们从**大气层内的观察者**开始一条射线，并将其延伸到无限远（见下图）。这条射线可以追溯到**最低高度的一个点** $r_0$。我们冒昧地称这一点为**近地点**。这里我们定义$t=0$，以及沿射线的**任何一点的高度**如下：

![image-20210819115314711](C5.assets/image-20210819115314711.png)

![image-20210819115155521](C5.assets/image-20210819115155521.png)

让我们进一步假设**一个球状对称的大气层**，其**密度呈指数下降**，其特征是比例高度`H`：

![image-20210819115524254](C5.assets/image-20210819115524254.png)

将这些表达式结合起来，就可以得到沿整个射线的积分。**积分边界**与观测者的高度`r`和入射角$χ$呈**三角关系**：

![image-20210819115834077](C5.assets/image-20210819115834077.png)

这个积分并没有一个简单的解，除非是在**直视向上看天顶**（$χ=0$）时除外。在这种情况下，沿射线的密度只是观察者上方空气柱的密度。根据密度分布的定义，这是一个尺度高度乘以观察者处的密度。让我们把这个质量称为$m_{⊥}$：

![image-20210819120216473](C5.assets/image-20210819120216473.png)

我们可能有一个函数将$m_{⊥}$与 $m$联系起来吗？我们可以，因为这是**查普曼函数**$Ch(x, χ)$：

![image-20210819120338139](C5.assets/image-20210819120338139.png)

`x`代表**归一化高度**，希腊字母`chi`代表**入射角**。该函数与`scale`无关，通常用表格或近似的数字来表示。为方便起见，下面给出了一个分析性的表达。这是从[Kocifaj 96]中发现的一个**更一般的解决方案**中剥离出来的。

![image-20210819120709046](C5.assets/image-20210819120709046.png)

上述表达式对于实时评估并不实用，原因有几个：它包含**互补的误差函数**`erfc`，它本身需要一个数值近似。在大x和小χ的情况下，它的数值表现不好，**exp项**变得非常大，**erfc项**几乎为零。然而，我们使用这个表达式作为我们的基础真实标准，用任意精度的数学软件来评估。



## 4. 实现实时逼近

![image-20210819125118192](C5.assets/image-20210819125118192.png)

为了更好地理解**查普曼函数**，我们将绘制它的图表（见上图），并观察一些重要的特性。

![image-20210819125142443](C5.assets/image-20210819125142443.png)

这些特性很容易解释。**偶数的对称性**来自于问题的说明。只有**入射角的余弦**出现在表达式中。这使我们可以将**覆盖范围**缩小到 $0 < χ < 180^o$。其次，由于$Ch(x, χ)$将$m_⊥$与$m$联系起来，它的值对于小入射角必须接近`1`。最后，在`flat earth`的限制下，**查普曼函数必须接近正割函数**。这

些特性可以用来设计我们的近似值。大`x`的极限表明是一个有理的近似，因为我们要应付**一个极点**。运行时间的效率要求尽可能的低阶。所以我们要寻找$cos χ$的**一阶有理函数**，左边接近`1`，右边接近$Ch_{||}(x)$的值，这样的**有理函数**只有一种可能：

![image-20210819125658337](C5.assets/image-20210819125658337.png)

事实证明，**这个低阶函数是一个相当好的近似值**。然而，$χ$的有用范围仅限于$90^o$以下。超过这个角度，近似值就会呈双曲线增长到无限大，而准确的查普曼函数则会呈指数增长，并始终保持有限。我们将寻找处理$χ > 90^o$的方法，但我们必须首先把注意力转向**系数c**。

### 在地平线

如果**观察者的高度是固定的**，我们可以预先计算出一个`c`的值。然而，对于一个移动的观察者，在没有**查普曼函数**可以依靠的情况下，我们需要一个`c`本身的近似值。让我们来看看$Ch_{||}(x)$：

![image-20210819125948499](C5.assets/image-20210819125948499.png)

![image-20210819130111663](C5.assets/image-20210819130111663.png)

### 在地平线之上

![image-20210819130239080](C5.assets/image-20210819130239080.png)

请看上图。沿着一整条线的空气质量$m_L$是**沿着前线的空气质量**，加上**沿着后线的空气质量**：

![image-20210819130247727](C5.assets/image-20210819130247727.png)

上述方程对沿线的任何一点都必须是真实的。我们可以将观察者移动到近地点，在那里，前向和后向射线都是水平的。用三角法计算，近地点的高度为$x_0 = x sin χ$，密度遵循$ρ*exp(x - x_0)$。因此，另一种表达$m_L$的方式是：

![image-20210819130447638](C5.assets/image-20210819130447638.png)

结合上述方程，有可能得出一个特性，即用**反射入射角**来表达查普曼函数本身：

![image-20210819130551957](C5.assets/image-20210819130551957.png)

如果**查普曼函数**在$0 < χ < 90^o$的情况下是已知的，那么它对所有$χ$都是已知的。



## 5. 实现

### 数值范围

首先，必须解决一个**数字范围的问题**，当`x`大而$x_0$小的时候就会出现这种情况。`identity formula`包含指数$exp(x - x_0)$，它溢出了。为了补救这种情况，我们引入了一个修改的函数$Ch_h(X, h, χ)$：

![image-20210819130922332](C5.assets/image-20210819130922332.png)

这个函数需要一个**参考高度**`X`和相应的观测者来计算空气质量。

[list 1]()

```c++
float chapman_h( float X, float h, float coschi) 
{
    // The approximate Chapman function 
    // Ch(X+h,chi) times exp2(-h) 
    // X - altitude of unit density 
    // h - observer altitude relative to X 
    // coschi - cosine of incidence angle chi 
    // X and h are given units of the 50%- height
    
    float c = sqrt(X + h); 
    if(coschi >= 0.)
    {
        // chi above horizon 
        return c / (c * coschi + 1.) * exp2(-h);
    } 
    else 
    {
        // chi below horizon , must use identity 
        float x0 = sqrt(1. - coschi * coschi) * (X + h); 
        float c0 = sqrt(x0); 
        return 2. * c0 * exp2(X - x0) - c / (1. - c * coschi) * exp2(-h);
    }

}
```



### Distance Differences

![image-20210819132040945](C5.assets/image-20210819132040945.png)

第二个修改涉及到近似值对**路径长度的和与差**保持忠实的能力。特别要注意的是**观察者靠近反射面上方**的情况。考虑上图。假设有接近水平的角度，三段的空气质量$m_A$、$m_B$和$m_C$可以被简化为：

![image-20210819132139689](C5.assets/image-20210819132139689.png)

现在的问题是，该近似值是否满足$m_A=m_B+m_C$ ？这将是在水面以上的地平线上实现精确的颜色匹配的要求。简短的回答是，原来的近似值在这个属性上不成立。有理函数中分母的形式，以及因子`1.2533`，阻碍了它。必须对近似值进行修改以实现这一特性；这个新的近似值甚至更简单。

![image-20210819132341121](C5.assets/image-20210819132341121.png)



### Using exp2

该代码将专门使用双指数$2^x$而不是自然指数$e^x$。因此，我们将需要把**所有的尺度**转换为双对数。我们需要一个50%高度的$H_{50}$，而不是`scale height` `H`；我们需要**50%的消减系数**：

![image-20210819132544796](C5.assets/image-20210819132544796.png)

这一变化的原因是，**exp2通常是更有效的函数**。为了进一步优化，一个实现可以采用一个**快速的exp2函数**进行所有散射计算。附录（第11.8节）中介绍了这样一个快速exp2函数的例子。

[list 2]()

```c++
//Function for the transmittance along a ray.

vec3 transmittance(vec3 r, vec3 viewdir) 
{

    // calculate the transmittance along a ray 
    // from point r towards infinity

    float rsq = dot(r,r); 
    float invrl = inversesqrt(rsq); 
    float len = rsq * invrl; 
    float x = len * invH50; 
    float h = x - X50; 
    float coschi = dot(r, viewdir) * invrl; 
    return exp2(-beta50 * H50 * chapman_h(X50, h, coschi));
}
```

```c++
float exp2pp( float x ) {
    // partial precision exp2 , accurate to 12 bits 
    
    const float c[3] = { 5.79525 , 12.52461 , -2.88611 }; 
    int e = round(x); 
    float t = x - e; 
    float m = (t * t + c[0] * t + c[1]) / (c[2] * t + c[1]); 
    return ldexp(m, e);
}
```



## 6. Putting the Chapman Function to Use

### Airmass and Transmittance

用**修改后的查普曼函数**可以很容易地计算出空气质量。你需要知道**观察者的高度**和参考高度（方便地说，这就是**行星半径，或平均海平面**），以及大气的比例高度：

![image-20210819133609960](C5.assets/image-20210819133609960.png)

**从空气质量到透射率**只有一小步，因为$T = exp(-βm) $。见清单`2`，有一个函数用于计算**沿直线通过大气层的透射率**。比例高度和消光系数必须是全局可用的。在完整的片段程序中，这个函数被用来计算表面渲染的局部太阳颜色。

### Aerial Perspective

完整的空中透视功能有两种颜色作为结果：==透射率和内散射==。该功能太长，不能在此列出，但在网站上的片段程序中包含了该功能。

```c++
void aerial_perspective(out vec3 T, out vec3 S, in vec3 r0
                        , in vec3 r1, in bool infinite );
```

该函数计算从点$r_0$到点$r_1$的**空中透视**，或者从点$r_0$沿射线通过$r_1$到无限远的空中透视。**所得的透射率**被写入参数`T`，**散射率**被写入参数`S`。在第一步中，函数将射线与**大气层边界**相交，得到积分区间，该区间被细分为固定数量的片段。然后，它以**相反的顺序（从后往前）**迭代所有段。对于每一段，调用**Chapman函数**来计算**空气质量、透射率和内散射**。然后，内散射以**类似于阿尔法混合的方式**沿射线传播。

### The Example Raytracer

//todo



