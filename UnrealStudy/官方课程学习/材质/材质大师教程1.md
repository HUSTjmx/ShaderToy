# 教程1

## 1. 整体架构

1. 首先，我们需要注意的是在编辑材质时，要小心其细节面板的`用法`分栏，我们需要明确其勾选，否则，很有可能导出后**报错**，部分材质无法显示，例如：一般情况下，哪怕没有勾选，UE4也会启动使用**静态光照**的版本。

2. 为什么编译着色器的数量如此惊人？理由和Unity一样，着色器内分支结构的使用会导致大量的**着色器变体**，每一个变体都要进行编译。

3. 大多数情况，我们无需专门去减少变体数量，保持默认设置即可。

4. 如果需要减少，可以修改如下设置：

   ![image-20210102193112096](材质大师教程1.assets/image-20210102193112096.png)

## 2. 性能

1. 对于材质而言，300以内的材质命令数是合理的（PC），但无论什么硬件环境，过千条的命令数都是不合理的。

## 3. PBR

1. 对于大多数情况，我们只需将`金属度`看作布尔值，`高光值`不用修改，默认使用0.5，着重修改粗糙度即可。

## 4. 压缩和内存

1. 之前也说了，UE4的压缩格式是DXTC或BC，而`矢量置换贴图`则是未压缩，同时，不要因为纹理是灰度图，就选择压缩方式中的`灰度`，这是误导。

   > 具体这些格式细节，可以见RTR4读书笔记

2. 密切关注纹理**信息面板**。

   ![image-20210102201520859](材质大师教程1.assets/image-20210102201520859.png)

3. 勾选`延迟压缩`，会停止在纹理导入时进行其他压缩操作，而变为在保存时进行压缩，这方便开发，是个不错的选项。
4. 法线贴图使用的是特殊的BC5压缩方式，只是要R、G通道。只要使用正确的压缩格式，就无需在着色（蓝图）中使用专门的函数来还原B通道。
5. 帧率问题一般和纹理无关。
6. 可以使用`统计数据窗口`来查看纹理内存使用的详细情况。
7. 使用命令：==stat Memory==，进行查看。

## 5. 纹理池

深入了解纹理如何通过流送、多级渐进纹理、纹理池大小等方面管理可用内存。我们将介绍如何在避免内存遭遇瓶颈的情况下将纹理细节最大化。

1. 根据项目需要，使用命令：r.Straming.PoolSize，来修改纹理池大小，因为项目默认值并不大（==2GB==）。

2. 纹理流送是系统决定使用哪张纹理和相应Mip的过程。

3. 进行纹理分组，方便管理

4. ==合并贴图==，本质是将RGB通道中的不同图像进行组合，例如：三个通道存储了三张纹理的$\alpha$通道。

   > 补充知识可见[纹理](..\实时渲染\实时渲染深入探究2.md)

## 6. 渲染目标

1. 在编辑器或渲染时生成的特殊纹理。

2. 其中，部分情况下使用的`SceneCapture`在**反射**一节也提到过。

3. 关于，怎么将程序纹理渲染进一张贴图中：通过算法生成程序材质，通过蓝图将材质应用到==渲染目标==上，最后将其转化为平常使用的**静态纹理**。

   | 相关对象                                              | 蓝图                                                  |
   | ----------------------------------------------------- | ----------------------------------------------------- |
   | ![](材质大师教程1.assets/image-20210102210233417.png) | ![](材质大师教程1.assets/image-20210102210317469.png) |

> 游戏中，所有雪的实现（在雪地走，雪被挤向两侧），都是基于渲染目标

## 7. 材质编辑器

![image-20210103192210756](材质大师教程1.assets/image-20210103192210756.png) 

常用的**数学公式**（HLSL中也是常见的）

   <img src="材质大师教程1.assets/image-20210103192554477.png" alt="image-20210103192554477" style="zoom:67%;" />

<img src="材质大师教程1.assets/image-20210103193432669.png" alt="image-20210103193432669" style="zoom:80%;" />

#### 动画序列视图

![image-20210103195152590](材质大师教程1.assets/image-20210103195152590.png)

#### 使用的外部信息

<img src="材质大师教程1.assets/image-20210103200238544.png" alt="image-20210103200238544" style="zoom:80%;" />

#### 世界对齐纹理

<img src="材质大师教程1.assets/image-20210103201315203.png" alt="image-20210103201315203" style="zoom:80%;" />

## 8. 简单组合

这里只会简单提及几个有意思的。具体可见教程，比较简单。

#### Bump Offset

| 蓝图                                                         | 效果                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <img src="材质大师教程1.assets/image-20210103202015029.png" alt="image-20210103202015029" style="zoom:67%;" /> | <img src="材质大师教程1.assets/image-20210103202038076.png" alt="image-20210103202038076" style="zoom:80%;" /> |

使用纹理的话，有种凸起感，（Offset的纹理使用的是同一张，不过要将**采样类型**设置为`线性颜色`）

| 蓝图                                                         | 效果                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <img src="材质大师教程1.assets/image-20210103202328011.png" alt="image-20210103202328011" style="zoom: 80%;" /> | <img src="材质大师教程1.assets/image-20210103202421595.png" style="zoom:80%;" /> |

一些用处：模仿老式显像管电视机、

#### 混合角度纠正法线

学了这么久图形学，这点还是清楚的，法线贴图的混合可和一般的不一样。

![image-20210103203036571](材质大师教程1.assets/image-20210103203036571.png)

当然，可以用乘法，来改变贴图强度，但是注意不要修改**蓝色通道**。

![image-20210103203225019](材质大师教程1.assets/image-20210103203225019.png)

#### 顶点着色

| 蓝图                                                         | 效果                                                  |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| <img src="材质大师教程1.assets/image-20210103203748557.png" style="zoom: 80%;" /> | ![](材质大师教程1.assets/image-20210103203813171.png) |

| 蓝图                                                         | 效果                                                  |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| <img src="材质大师教程1.assets/image-20210103203925701.png" style="zoom: 67%;" /> | ![](材质大师教程1.assets/image-20210103203937820.png) |



## 9. 材质输入

这节我们聚焦于用**HLSL**编写的==渲染模板==。**重点**是`材质域`、`混合模式`、`渲染模型`

| 模板                                                  | 控制面板                                              |
| ----------------------------------------------------- | ----------------------------------------------------- |
| ![](材质大师教程1.assets/image-20210103204520057.png) | ![](材质大师教程1.assets/image-20210103204559339.png) |

#### Displacement

一个简单的==置换贴图==的蓝图

![](材质大师教程1.assets/image-20210103205802859.png)

效果图

![image-20210103210016402](材质大师教程1.assets/image-20210103210016402.png)

提醒下，这种方法实际改变了==几何网格==，并且做了曲面细分，建议**参考上限数**为16。

![image-20210103210326588](材质大师教程1.assets/image-20210103210326588.png)

对了，如果要启用这个技术，需要修好材质细节面板，如下：

![](材质大师教程1.assets/image-20210103210653896.png)

#### 世界位置偏移

这个方法的实现方式和原理和`Displacement`比较相似，其简单使用的蓝图如下：

![](材质大师教程1.assets/image-20210103211317155.png)

基本原理：使用**顶点着色器**对顶点位置进行进一步偏移。此技术和`Displacement`的最大区别在于，这个技术必须使用==高模模型==，而不能进行曲面细分（显而易见）。

![](材质大师教程1.assets/image-20210103212001684.png)

| 置换                               | 世界位置偏移                                   |
| ---------------------------------- | ---------------------------------------------- |
| 可以根据平台，调节细分数，控制性能 | 可以根据需要对模型的不同部分采取不同的细分程度 |

而且，实际上，这里的例子并不是==世界位置偏移==的常规用处，而是诸如**草丛或植物类对象**:arrow_down:，或者布料。

![image-20210103213158113](材质大师教程1.assets/image-20210103213158113.png)

![image-20210103213250101](材质大师教程1.assets/image-20210103213250101.png)

还有简单的==海面==

![image-20210103214219979](材质大师教程1.assets/image-20210103214219979.png)

![image-20210103214318767](材质大师教程1.assets/image-20210103214318767.png)

再比如，使用此技术让物体旋转

![image-20210103214529363](材质大师教程1.assets/image-20210103214529363.png)

#### 环境光遮蔽

![image-20210103215123323](材质大师教程1.assets/image-20210103215123323.png)

对于UE4引擎，我们需要知道的是，在材质中使用**环境光遮蔽**，<span style="color:red;font-size:1.3rem">只能在静态光照模型上使用和显示</span>。因此，需要注意它实际会不会生效，所以实际上很多材质从来不使用AO。

#### 像素深度偏移

2018年**UE4**更新的新技术，当时使用还较少，

| 蓝图                                                  | 效果                                                  |
| ----------------------------------------------------- | ----------------------------------------------------- |
| ![](材质大师教程1.assets/image-20210103215806748.png) | ![](材质大师教程1.assets/image-20210103215840152.png) |

这个圆环的空心部分，实际上已经偏移到了地面之下，被覆盖了，不会显示出来，如果让圆盘继续向上，则空心部分会变小，因为两者的距离差超过了$[0,1]\times 250$（例子中的）。

用处呢，比如：我们不希望人物的刘海穿模，比如，草丛的分布应该有层次感:arrow_down:。

| Bad                                                   | Good                                                         |
| ----------------------------------------------------- | ------------------------------------------------------------ |
| ![](材质大师教程1.assets/image-20210103220640926.png) | ![image-20210103220556820](材质大师教程1.assets/image-20210103220556820.png) |

也可让==视差贴图==有如下效果——和物体相交的正确性。

![image-20210103220930352](材质大师教程1.assets/image-20210103220930352.png)



## 10. 着色模式（部分）

#### Unlit（无光照）

| 蓝图                                                         | 效果                                                  |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| <img src="材质大师教程1.assets/image-20210104203131203.png" style="zoom:80%;" /> | ![](材质大师教程1.assets/image-20210104203028595.png) |

> 能提升性能，减少不必要的性能

#### 次表面

| 蓝图                                                         | 效果                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------ |
| ![image-20210104204112478](材质大师教程1.assets/image-20210104204112478.png) | ![ ](材质大师教程1.assets/image-20210104204143836.png) |

此模型仅适用于`可移动`和`固定`光。

<span style="color:red;font-size:1.3rem">SubSurface Profile</span>

除了勾选`SubSurface`，还可以勾选==SubSurface Profile==，通过**模糊**进行拟合，来实现这种效果：

| 细节面板                                                     | Asset面板                                                    |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20210104204758320](材质大师教程1.assets/image-20210104204758320.png) | <img src="材质大师教程1.assets/image-20210104204916398.png" style="zoom: 80%;" /> |

 

| 蓝图                                                         | 效果                                                  |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| <img src="材质大师教程1.assets/image-20210104205330187.png" style="zoom:80%;" /> | ![](材质大师教程1.assets/image-20210104205416657.png) |

#### Two Sided Foliage

在游戏中，植物渲染一直存在一个问题，因为植物实际上是由不同的平面组成的，它们会相交且朝向各不相同，问题在于无法生成看上去统一的光照。我们需要如下效果： 

| 正面                                                         | 背面                                                  |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| <img src="材质大师教程1.assets/image-20210104205906425.png" style="zoom:80%;" /> | ![](材质大师教程1.assets/image-20210104205950385.png) |

选择`Two Sided Foliage`，这实际上也是一种==次表面方法==。

![](材质大师教程1.assets/image-20210104210140919.png)



#### Clear Coat

| 蓝图                                                  | 效果                                                  |
| ----------------------------------------------------- | ----------------------------------------------------- |
| ![](材质大师教程1.assets/image-20210104210701454.png) | ![](材质大师教程1.assets/image-20210104210722376.png) |

==独特核心==

![image-20210104211154054](材质大师教程1.assets/image-20210104211154054.png)

取消勾选**项目设置**中的如下选项:arrow_down:，可以禁用上诉:arrow_up:的特殊节点。所以说底层法线才会作为特殊节点，而不少着色模型上的一个输入。

![image-20210104211400270](材质大师教程1.assets/image-20210104211400270.png)



## 11. 混合模式

#### Translucent

1. 在处理混合模式中`Translucent`，由于`G Buffer`的限制，有光照和无光照的渲染基本无区别，所以在这种情况下，最好使用`unlit`。

    | 细节                                                  | 蓝图                                                  |
    | ----------------------------------------------------- | ----------------------------------------------------- |
    | ![](材质大师教程1.assets/image-20210104213218634.png) | ![](材质大师教程1.assets/image-20210104213248203.png) |

    

2. 也可以启用高级版本，不过需要更改细节面板中的`半透明`分栏：勾选`屏幕空间反射`；更改下方的`光照模式`为==Surface ForwardShading==

    ![image-20210104213528601](材质大师教程1.assets/image-20210104213528601.png)

    | 蓝图                                                  | 效果                                                  |
    | ----------------------------------------------------- | ----------------------------------------------------- |
    | ![](材质大师教程1.assets/image-20210104213557727.png) | ![](材质大师教程1.assets/image-20210104213624851.png) |

    > 此高级版本的性能消耗，有二十来条指令，激增到了超过700条

3. 关于==透明面板==的一些设置。

    ![image-20210104214449908](材质大师教程1.assets/image-20210104214449908.png)

    关于`Apply Fog`，取消勾选，玻璃就不会收到`远距离雾化`的影响，`Compute Fog Per Pixel`对于渲染大规模的半透明表面，如`海面`，效果不错。

    ![](材质大师教程1.assets/image-20210104214701432.png)

    关于`Render After DOF`，半透明物体的模糊渲染不太对劲时，可以修改此项，看看效果。`Disable depth Test`可以应用于那些需要始终在屏幕上呈现的物体。

    ![image-20210104214927381](材质大师教程1.assets/image-20210104214927381.png)

    对于`Lighting Mode`，从上至下，开销不断增大，效果不断变好（第一项是默认的，此段话太绝对，有错误）。然后，关于第一项，它实际上对应用表面进行了细分，但依然存在渲染动态物体不够平滑的问题，可以使用命令：**r.TranslucencyLightingVolumeDim**进行设置和查询。



#### Masked

主要用于处理**排序困难**的植物（我们也早就知道，植物类都是按照透明物体进行处理的），就要选择混合模式`Masked`。

| 蓝图                                                         | 效果                                                  |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| <img src="材质大师教程1.assets/image-20210104220006541.png" style="zoom:80%;" /> | ![](材质大师教程1.assets/image-20210104215940713.png) |



#### Translucent Dithered

这种透明表面存在反射、存在**PBR**，其缺点是：带有重影。混合模式依然选择`Masked`，但需要使用特殊的函数节点：==Dither TemporalAA==。其本质是：**将表面划分为大量小型像素，来使其呈现半透明效果**——每个像素交替可见或不可见。

| 蓝图                                                  | 效果                                                  |
| ----------------------------------------------------- | ----------------------------------------------------- |
| ![](材质大师教程1.assets/image-20210104220445994.png) | ![](材质大师教程1.assets/image-20210104220715667.png) |

![](材质大师教程1.assets/image-20210104220757374.png)

此方法虽然存在一些视觉瑕疵，但性能消耗却是极少的。



#### Additive and Modulate

`Additive`即用于在顶层添加颜色，本身并非透明；`Modulate`与之相反，它移除所有明亮的部分，仅保留较暗的像素处于可见状态，此方法很实用，可用于污渍、泥土、爆炸痕迹。使用也很简单，选择对应的混合模式即可。

![](材质大师教程1.assets/image-20210104221238286.png)

#### 折射

一切保持默认，只是使用了模板的折射输入。

![image-20210105123845480](材质大师教程1.assets/image-20210105123845480.png)

有时候会出现上图左:arrow_up:的情况，可以通过修改材质细节面板中的`Refraction mode`为后者，来达到上图右的较好效果。总而言之，面对类似的情况，可以通过修改此项来尝试解决。

![image-20210105124012766](材质大师教程1.assets/image-20210105124012766.png)

#### 总结

![image-20210105124246043](材质大师教程1.assets/image-20210105124246043.png)



## 12. 材质域

#### 贴花 Decals

选择材质域为`延迟Decal`

| 蓝图                                                         | 效果                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <img src="材质大师教程1.assets/image-20210105125012566.png" alt="image-20210105125012566" style="zoom:67%;" /> | ![image-20210105125107295](材质大师教程1.assets/image-20210105125107295.png) |

#### 光照函数

`light function`支持我们创建材质，让给让其与光照相结合。

| 蓝图                                                         | 效果                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20210105125528659](材质大师教程1.assets/image-20210105125528659.png) | ![image-20210105125811406](材质大师教程1.assets/image-20210105125811406.png) |

这里的实例可能不是很实用，实际上，我们在之前的教程中也碰到过，可以使用这个技术来模拟水中的==焦散效果==。对`定向光源`使用光照函数，可以方便产生==云阴影==效果。

#### 后期处理混合物

![image-20210105130252258](材质大师教程1.assets/image-20210105130252258.png)

| 设置                                                         | 蓝图                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20210105130424870](材质大师教程1.assets/image-20210105130424870.png) | ![image-20210105130537388](材质大师教程1.assets/image-20210105130537388.png)![image-20210105130605432](材质大师教程1.assets/image-20210105130605432.png) |

![image-20210105130818234](材质大师教程1.assets/image-20210105130818234.png)

![image-20210105130859846](材质大师教程1.assets/image-20210105130859846.png)

关于后期处理材质的详细内容可见[官方手册](https://docs.unrealengine.com/zh-CN/RenderingAndGraphics/PostProcessEffects/PostProcessMaterials/index.html?utm_source=editor&utm_medium=docs&utm_campaign=rich_tooltips)

我们可以使用此技术来创造对象轮廓，用于千奇百怪的冷热效果，下雨或水下效果。（个人感觉，风格化渲染）

#### Volume

将体积纹理应用在粒子上，可以生成==体积雾==。

![image-20210105131634782](材质大师教程1.assets/image-20210105131634782.png)

| 蓝图                                                         | 效果                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20210105131722183](材质大师教程1.assets/image-20210105131722183.png) | ![image-20210105131703126](材质大师教程1.assets/image-20210105131703126.png) |

